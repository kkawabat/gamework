name: Deploy Signaling Server to Droplet

on:
  push:
    paths:
      - 'signaling-server/**'
      - '.github/workflows/deploy-signaling-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Deploy to Droplet
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DROPLET_SSH_KEY }}
        port: ${{ secrets.DROPLET_PORT || 22 }}
        script: |
          set -e
          
          echo "üöÄ Starting GameWork Signaling Server Deployment"
          echo "=============================================="
          
          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m' # No Color
          
          print_status() {
              echo -e "${GREEN}[INFO]${NC} $1"
          }
          
          print_warning() {
              echo -e "${YELLOW}[WARNING]${NC} $1"
          }
          
          print_error() {
              echo -e "${RED}[ERROR]${NC} $1"
          }
          
          # Check if directory exists, if not clone the repo
          if [ ! -d "/opt/gamework" ]; then
              print_status "Cloning GameWork repository..."
              mkdir -p /opt
              cd /opt
              git clone https://github.com/kkawabat/gamework.git
          else
              print_status "Updating GameWork repository..."
              cd /opt/gamework
              git pull
          fi
          
          # Navigate to the signaling server directory
          cd /opt/gamework/signaling-server
          
          # Check if Docker is running
          if ! docker info > /dev/null 2>&1; then
              print_error "Docker is not running. Please start Docker service."
              exit 1
          fi
          
          # Check if the app_network exists
          if ! docker network ls | grep -q "app_network"; then
              print_error "app_network does not exist. Please ensure your reverse proxy is running."
              exit 1
          fi
          
          # Stop any existing signaling server container
          print_status "Stopping any existing signaling server containers..."
          docker-compose down 2>/dev/null || true
          
          # Remove any existing container with the same name
          if docker ps -a --format "table {{.Names}}" | grep -q "gamework-signalling-server"; then
              print_status "Removing existing gamework-signalling-server container..."
              docker rm -f gamework-signalling-server 2>/dev/null || true
          fi
          
          # Build and start the new container
          print_status "Building and starting the signaling server..."
          docker-compose up -d --build
          
          # Wait for the container to be ready
          print_status "Waiting for server to be ready..."
          sleep 15
          
          # Check if the container is running
          if docker ps --format "table {{.Names}}\t{{.Status}}" | grep -q "gamework-signalling-server.*Up"; then
              print_status "‚úÖ Signaling server is running successfully!"
              
              # Show container status
              echo ""
              print_status "Container status:"
              docker ps --filter "name=gamework-signalling-server" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              
              # Show network connectivity
              echo ""
              print_status "Network connectivity:"
              docker network inspect app_network | grep -A 5 -B 5 "gamework-signalling-server" || echo "Container not found in app_network"
              
              # Show recent logs
              echo ""
              print_status "Recent logs:"
              docker-compose logs --tail=20
              
              # Test WebSocket connection
              echo ""
              print_status "Testing WebSocket connection..."
              if command -v wscat > /dev/null 2>&1; then
                  timeout 5 wscat -c ws://localhost:8080 || print_warning "WebSocket test failed (this is normal if wscat is not available)"
              else
                  print_warning "wscat not available for WebSocket testing"
              fi
              
          else
              print_error "‚ùå Failed to start the signaling server"
              print_status "Checking logs for errors:"
              docker-compose logs
              exit 1
          fi
          
          echo ""
          print_status "üéâ Deployment completed successfully!"
          echo ""
          print_status "Useful commands:"
          echo "  View logs:     docker-compose logs -f"
          echo "  Stop server:   docker-compose down"
          echo "  Restart:       docker-compose restart"
          echo "  Update:        git pull && docker-compose up -d --build"
          echo ""
          print_status "Container name: gamework-signalling-server"
          print_status "Network: app_network"
          print_status "Port: 8080 (internal)"
          print_status "Ready for Caddy reverse proxy configuration!"
